<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenTripMap Tester</title>
    <script>
        const apiKey = "5ae2e3f221c38a28845f05b699e9a2ad4696a9c9cb1681a5b553489f";
        const pageLength = 5;
        let lon, lat, offset = 0, count;
        
        function apiGet(method, query) {
            return fetch(`https://api.opentripmap.com/0.1/en/places/${method}?apikey=${apiKey}&${query}`)
                .then(response => response.json())
                .catch(err => console.log("Fetch Error :-S", err));
        }
        
        function firstLoad() {
            apiGet("radius", `radius=1000&limit=${pageLength}&offset=${offset}&lon=${lon}&lat=${lat}&rate=2&format=count`)
                .then(data => {
                    count = data.count;
                    offset = 0;
                    document.getElementById("info").innerHTML += `<p>${count} objects found in 1km radius</p>`;
                    loadList();
                });
        }
        
        function loadList() {
            apiGet("radius", `radius=1000&limit=${pageLength}&offset=${offset}&lon=${lon}&lat=${lat}&rate=2&format=json`)
                .then(data => {
                    let list = document.getElementById("list");
                    list.innerHTML = "";
                    data.forEach(item => list.appendChild(createListItem(item)));
                    let nextBtn = document.getElementById("next_button");
                    nextBtn.style.visibility = count < offset + pageLength ? "hidden" : "visible";
                    nextBtn.innerText = `Next (${offset + pageLength} of ${count})`;
                });
        }
        
        function createListItem(item) {
            let a = document.createElement("a");
            a.className = "list-group-item list-group-item-action";
            a.setAttribute("data-id", item.xid);
            a.innerHTML = `<h5>${item.name}</h5><p>${item.kinds}</p>`;
            a.addEventListener("click", function() {
                document.querySelectorAll("#list a").forEach(el => el.classList.remove("active"));
                this.classList.add("active");
                apiGet("xid/" + this.getAttribute("data-id")).then(onShowPOI);
            });
            return a;
        }
        
        function onShowPOI(data) {
            let poi = document.getElementById("poi");
            poi.innerHTML = data.preview ? `<img src="${data.preview.source}">` : "";
            poi.innerHTML += data.wikipedia_extracts ? data.wikipedia_extracts.html : data.info ? data.info.descr : "No description";
            poi.innerHTML += `<p><a target="_blank" href="${data.otm}">Show more at OpenTripMap</a></p>`;
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("search_form").addEventListener("submit", function(event) {
                event.preventDefault();
                let name = document.getElementById("textbox").value;
                apiGet("geoname", "name=" + name).then(data => {
                    if (data.status === "OK") {
                        document.getElementById("info").innerHTML = `${data.name}, ${data.country}`;
                        lon = data.lon;
                        lat = data.lat;
                        firstLoad();
                    } else {
                        document.getElementById("info").innerHTML = "Name not found";
                    }
                });
            });
            
            document.getElementById("next_button").addEventListener("click", function() {
                offset += pageLength;
                loadList();
            });
        });
    </script>
</head>
<body>
    <h1>OpenTripMap API Tester</h1>
    <form id="search_form">
        <input type="text" id="textbox" placeholder="Enter place name" required>
        <button type="submit">Search</button>
    </form>
    <div id="info"></div>
    <div id="list"></div>
    <button id="next_button" style="visibility:hidden;">Next</button>
    <div id="poi"></div>
</body>
</html>
